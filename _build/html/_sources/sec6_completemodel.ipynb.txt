{
 "cells": [
  {
   "attachments": {},
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# 6  Complete Model and HJB \n",
    "\n",
    "We specify here that the four subvectors of Brownian motion are mutually independent. Hence, we make further definition of distortion as \n",
    "\n",
    "$$\n",
    "h = \\begin{bmatrix} {h^k} \\cr {h^r} \\cr {h^y} \\cr \\end{bmatrix}\n",
    "$$\n",
    "\n",
    "For our analysis here, rather than a constant value of $\\xi$ for all uncertainty channels, we use a set of values $\\{\\xi^k, \\xi^c, \\xi^r, \\xi^d, \\xi^g\\}$, one for each uncertainty channel so that we can carry out our uncertainty decompositions.\n",
    "\n",
    "<!-- corresponding to capital misspecification, temperature anomaly misspecification, R&D stock misspecification, damage jump misspecification, technology jump misspecification.  -->\n",
    "\n",
    "\n",
    "\n",
    "We define realizations of controls and states as following:\n",
    "\n",
    "Controls:\n",
    "\n",
    "- $i^k$ is a potential value for $I_t^k$\n",
    "- $i^r$ is a potential value for $I_t^r$\n",
    "- $e$ is a potential value for $\\mathcal{E}_t$\n",
    "- ${h^k}$ is the distortion to capital accumulation.\n",
    "- ${h^y}$ is the distortion to temperature anomaly accumulation.\n",
    "- ${h^r}$ is the distortion to R\\&D accumulation.\n",
    "- $g$ is the misspecification to technology jump.\n",
    "- $f$ is the misspecification to damage jump.\n",
    "\n",
    "\n",
    "State: \n",
    "\n",
    "- $k$ is a realization of $K_t$.\n",
    "- $y$ is a realization of $Y_t$.\n",
    "- $r$ is a realization of $R_t$.\n",
    "- $n$ is a realization of $N_t$.\n",
    "\n",
    "## 6.1 Post Technology Jump\n",
    "\n",
    "### 6.1.1 Post Technology and Post Damage Jump\n",
    "\n",
    "We have HJB for post technology and post damage jump as follows\n",
    "\n",
    "\\begin{aligned}\n",
    "0= & \\max_{i^k}\\min_{{h^k}} \\left(\\frac{\\delta}{1-\\rho}\\right)\\left[\\left(\\frac{\\alpha k -i^k}{\\exp (\\tilde{v}(\\tilde{x}(\\tilde{z}), \\tilde{z}))} \\right)^{1-\\rho}-1\\right] \\\\\n",
    "& +\\frac{d \\tilde{v}(\\tilde{x}(\\tilde{z}), \\tilde{z})}{d \\log k}\\left[\\mu_k+\\frac{i^k}{k}-\\frac{\\kappa}{2} \\left(\\frac{i^k}{k}\\right)^2-\\frac{\\left|\\sigma_k\\right|^2}{2}+\\sigma_k {h^k}\\right]+\\frac{d^2 \\tilde{v}(\\tilde{x}(\\tilde{z}), \\tilde{z})}{d \\log k^2} \\frac{\\left|\\sigma_k\\right|^2}{2} \\\\\n",
    "& +\\xi^k \\frac{\\left|{h^k}\\right|^2}{2}\n",
    "\\end{aligned}\n",
    "\n",
    "\n",
    "where $\\tilde{z} \\in \\{(1,1), (1,2), \\ldots, (1,L_n)\\}$ \n",
    "\n",
    "### 6.1.2 Post Technology and Pre Damage Jump\n",
    "\n",
    "\n",
    "We have HJB for post technology and post damage jump as follows\n",
    "\n",
    "\\begin{aligned}\n",
    "0= & \\max_{i^k}\\min_{{h^k}} \\left(\\frac{\\delta}{1-\\rho}\\right)\\left[\\left(\\frac{\\alpha k -i^k}{\\exp (\\tilde{v}(\\tilde{x}(\\tilde{z}), \\tilde{z}))} \\right)^{1-\\rho}-1\\right] \\\\\n",
    "& +\\frac{d \\tilde{v}(\\tilde{x}(\\tilde{z}), \\tilde{z})}{d \\log k}\\left[\\mu_k+\\frac{i^k}{k}-\\frac{\\kappa}{2} \\left(\\frac{i^k}{k}\\right)^2-\\frac{\\left|\\sigma_k\\right|^2}{2}+\\sigma_k {h^k}\\right]+\\frac{d^2 \\tilde{v}(\\tilde{x}(\\tilde{z}), \\tilde{z})}{d \\log k^2} \\frac{\\left|\\sigma_k\\right|^2}{2} \\\\\n",
    "& +\\xi^k \\frac{\\left|{h^k}\\right|^2}{2}\n",
    "\\end{aligned}\n",
    "\n",
    "\n",
    "where $\\tilde{z} \\in \\{(1,0)\\}$ \n",
    "\n",
    "\n",
    "\n",
    "## 6.2 Pre technology Jump\n",
    "\n",
    "### 6.2.1 Pre Technology and Post Damage Jump\n",
    "\n",
    "\n",
    "The solution has a quasi-analytical simplification of the form\n",
    "$$\n",
    "\\tilde{V}\\left(X_t, Z_t\\right)=\\tilde{v}\\left(X_t^1, Z_t\\right)-\\log N\n",
    "$$\n",
    "\n",
    "\n",
    "After plugging this simplification into our HJB equation and removing common terms,\n",
    "we are left with the following simplified HJB to solve:\n",
    "\n",
    "\n",
    "\\begin{aligned}\n",
    "& 0=\\max_{i^k, i^r, e} \\min_{{h^k}, {h^y}, {h^r}, g} \\left(\\frac{\\delta}{1-\\rho}\\right)\\left[\\left(\\frac{\\alpha k -i^k-i^r-\\alpha k \\phi_0(z)\\left[1-\\frac{e}{\\beta_t \\alpha k }\\right]^{\\phi_1}}{\\exp (\\tilde{v})} \\right)^{1-\\rho}-1\\right] \\\\\n",
    "& +\\frac{\\partial \\tilde{v}}{\\partial \\log k}\\left[\\mu_k+\\frac{i^k}{k}-\\frac{\\kappa}{2} \\left(\\frac{i^k}{k}\\right)^2-\\frac{\\left|\\sigma_k\\right|^2}{2}+\\sigma_k {h^k}\\right]+\\frac{\\partial^2 \\tilde{v}(\\tilde{x}(\\tilde{z}), \\tilde{z})}{\\partial \\log k^2} \\frac{\\left|\\sigma_k\\right|^2}{2} \\\\\n",
    "& +\\frac{\\partial \\tilde{v}}{\\partial y}\\left(\\frac{1}{L_y} \\sum_{\\ell=1}^{L_y} q(\\ell \\mid x,z) \\theta(\\ell)+\\varsigma {h^y}\\right) e+\\frac{\\partial^2 \\tilde{v}}{\\partial y^2} \\frac{|\\varsigma|^2}{2} e^2 \\\\\n",
    "& -\\left(\\left[\\lambda_1+\\lambda_2 y+\\lambda_3(y-\\bar{y})\\right]\\left(\\frac{1}{L_y} \\sum_\\ell^{L_y} q(\\ell \\mid x,z) \\theta(\\ell)+\\varsigma {h^y}\\right) e+\\left(\\lambda_2+\\lambda_3\\right) \\frac{|\\varsigma|^2}{2} e^2\\right) \\\\\n",
    "& +\\frac{\\partial \\tilde{v}}{\\partial \\log r}\\left(-\\zeta+\\psi_0\\left(i^r\\right)^{\\psi_1} \\exp \\left(-\\psi_1 \\log r\\right)-\\frac{\\left|\\sigma_r\\right|^2}{2}+\\sigma_r {h^r}\\right)+\\frac{\\partial^2 \\tilde{v}}{\\partial \\log r^2}\\frac{\\left|\\sigma_r\\right|^2}{2} \\\\\n",
    "& +\\xi^g \\mathcal{J}_g(r)(1-g(\\tilde{z} \\mid x, z)+g(\\tilde{z} \\mid x, z) \\log g(\\tilde{z} \\mid x, z))+\\mathcal{J}_g(r) g(\\tilde{z} \\mid x, z)\\left(\\tilde{v}(\\tilde{x}(\\hat{z}), \\hat{z})-\\tilde{v}\\right) \\\\\n",
    "& +\\xi^k \\frac{\\left|{h^k}\\right|^2}{2}+\\xi^c \\frac{\\left|{h^y}\\right|^2}{2}+\\xi^r \\frac{\\left|{h^r}\\right|^2}{2}+\\chi \\frac{1}{L_y} \\sum_\\ell^{L_y}  q(\\ell \\mid x,z) \\log  q(\\ell \\mid x,z) \\\\\n",
    "&\n",
    "\\end{aligned}\n",
    "\n",
    "where the first component for $\\hat{z}$ is 1.\n",
    "\n",
    "\n",
    "### 6.2.1 Pre Technology and Pre Damage Jump\n",
    "\n",
    "\n",
    "\n",
    "We attempt to solve a value function of the form \n",
    "\n",
    "$$\n",
    "\\hat{V}\\left(X_t, Z_t\\right)=v\\left(X_t^1, Z_t\\right)-\\log N\n",
    "$$\n",
    "\n",
    "\n",
    "\\begin{aligned}\n",
    "0 & = \\max_{i^k, i^r, e} \\min_{{h^k}, {h^y}, {h^r}, g, f}\\left(\\frac{\\delta}{1-\\rho}\\right)\\left[\\left(\\frac{\\alpha k-i^k-i^r-\\alpha k \\phi_0(z)\\left[1-\\frac{e}{\\beta_t \\alpha k}\\right]^{\\phi_1}}{\\exp (v)} \\right)^{1-\\rho}-1\\right] \\\\\n",
    "& +\\frac{\\partial v}{\\partial \\log k}\\left[\\mu_k+\\frac{i^k}{k}-\\frac{\\kappa}{2} \\left(\\frac{i^k}{k}\\right)^2-\\frac{\\left|\\sigma_k\\right|^2}{2}+\\sigma_k {h^k}\\right]+\\frac{\\partial^2 v}{\\partial \\log k^2} \\frac{\\left|\\sigma_k\\right|^2}{2} \\\\\n",
    "& +\\frac{\\partial v}{\\partial y}\\left(\\frac{1}{L_y} \\sum_{\\ell=1}^{L_y} q(\\ell \\mid x,z) \\theta(\\ell)+\\varsigma {h^y}\\right) e+\\frac{\\partial^2 v}{\\partial y^2} \\frac{|\\varsigma|^2}{2} e^2 \\\\\n",
    "& -\\left(\\left[\\lambda_1+\\lambda_2 y\\right]\\left(\\frac{1}{L_y} \\sum_{\\ell=1}^{L_y} q(\\ell \\mid x,z) \\theta(\\ell)+\\varsigma {h^y}\\right) e+\\lambda_2 \\frac{|\\varsigma|^2}{2} e^2\\right) \\\\\n",
    "& +\\frac{\\partial v}{\\partial \\log r}\\left(-\\zeta+\\psi_0\\left(i^r\\right)^{\\psi_1} \\exp \\left(-\\psi_1 \\log r\\right)-\\frac{\\left|\\sigma_r\\right|^2}{2}+\\sigma_r {h^r}\\right)+\\frac{\\partial^2 v}{\\partial \\log r^2} \\frac{\\left|\\sigma_r\\right|^2}{2} \\\\\n",
    "& +\\xi^g \\mathcal{J}_g(r)(1-g(\\tilde{z} \\mid x, z)+g(\\tilde{z} \\mid x, z) \\log g(\\tilde{z} \\mid x, z))+\\mathcal{J}_g(r) g(\\tilde{z} \\mid x, z)\\left(\\tilde{v}(\\tilde{x}(\\tilde{z}), \\tilde{z})-v\\right) \\\\\n",
    "& +\\xi^d \\mathcal{J}_n(y) \\sum_{\\tilde{z} \\in \\mathcal{Z}} \\pi(\\tilde{z} \\mid x, z)(1-f(\\tilde{z} \\mid x, z)+f(\\tilde{z} \\mid x, z) \\log f(\\tilde{z} \\mid x, z)) \\\\\n",
    "& +\\mathcal{J}_n(y) \\sum_{\\tilde{z} \\in \\mathcal{Z}} \\pi(\\tilde{z} \\mid x, z) f(\\tilde{z} \\mid x, z)\\left(\\tilde{v}(\\tilde{x}(\\tilde{z}), \\tilde{z})-v\\right) \\\\\n",
    "& +\\xi^k \\frac{\\left|{h^k}\\right|^2}{2}+\\xi^c \\frac{\\left|{h^y}\\right|^2}{2}+\\xi^r \\frac{\\left|{h^r}\\right|^2}{2}+\\chi \\frac{1}{L_y} \\sum_{\\ell=1}^{L_y} q(\\ell \\mid x,z) \\log q(\\ell \\mid x,z)\n",
    "\\end{aligned}"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "base",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.7"
  },
  "orig_nbformat": 4
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
